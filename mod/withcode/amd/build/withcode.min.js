define(["jquery"],function(a){var b={toolsVisible:!1,editFile:function(a){b.files[b.currentFile]&&(b.files[b.currentFile]=b.editor.getValue()),b.currentFile=a,b.editor.setValue(b.files[a]),b.editor.clearSelection(),b.editor.focus();var c=a.match(/(\.[^.]+)/);switch(c&&c.length>1&&(c=c[1]),c){case".py":b.editor.getSession().setMode("ace/mode/python");break;case".html":b.editor.getSession().setMode("ace/mode/html");break;case".js":b.editor.getSession().setMode("ace/mode/javascript");break;case".sql":b.editor.getSession().setMode("ace/mode/mysql");break;default:b.editor.getSession().setMode("ace/mode/text")}b.updateFileTabs()},updateFileTabs:function(){var c="";for(var d in b.files)c+='<span class="file_tab',d==b.currentFile?(c+=' file_tab_selected">',"try_it.py"!=d&&"debug_it.py"!=d&&"extend_it.py"!=d&&(c+='<img class="btn_file_settings" alt="File settings" title="File settings" src="pix/settings.png">')):c+='">',c+=d+"</span>";c+='<span class="file_tab"><img class="btn_file_settings" alt="Create new file" title="Create new file" src="pix/tools.png"></span>',a("#file_tabs").html(c),a(".file_tab").click(function(c){var d=c.currentTarget.textContent;switch(d){case"":d="newfile.txt",void 0===b.files[d]&&(b.files[d]=""),b.editFile("newfile.txt");break;case b.currentFile:"try_it.py"!=d&&"debug_it.py"!=d&&"extend_it.py"!=d&&(a("#file_settings").show().modal(),a("#txt_file_name").val(d).focus());break;default:b.editFile(c.currentTarget.textContent)}})},currentFile:"try_it.py",countFiles:function(){var a=0;for(var c in b.files)a++;return a},files:{"try_it.py":""},readFile:function(a){return b.files[a]},writeFile:function(a,c){b.files[a]=c,b.updateFileTabs()},welcomeMessage:"Press Ctrl+Enter to run",getOption:function(a,b){return localStorage&&localStorage["OPT_"+a]?localStorage["OPT_"+a]:b},setOption:function(a,b){return localStorage["OPT_"+a]=b,b},showHint:function(c){b.hideHintTimeout&&clearTimeout(b.hideHintTimeout),b.hideHintTimeout=setTimeout(function(){delete b.hideHintTimeout,a("#hintBar").fadeOut()},5e3),a("#hintBar").html(c).show()},python:{outputListeners:[],output:function(a,c){var d=void 0==c?"consoleOut":"headerOut",e=document.getElementById(d);e.innerHTML+=a;for(var f=0;f<b.python.outputListeners.length;){var g=b.python.outputListeners[f];try{g(a),f++}catch(h){b.python.outputListeners.splice(f,1)}}var e=e.parentNode.parentNode;e.scrollTop=e.scrollHeight},clear:function(){var a=document.getElementById("consoleOut");a.innerHTML="";var a=a.parentNode.parentNode;a.scrollTop=a.scrollHeight},builtinread:function(a){if(void 0===Sk.builtinFiles||void 0===Sk.builtinFiles.files[a])throw"File not found: '"+a+"'";return Sk.builtinFiles.files[a]}},runAsync:function(a){var c,d=new Promise(a),e=new Sk.misceval.Suspension;return e.resume=function(){return c},e.data={type:"Sk.promise",promise:d.then(function(a){return c=a,a},function(a){return c="",b.handleError(a),new Promise(function(a,b){})})},e},watchVariables:{expandHandlers:[]},runCode:function(c){if(b.unhandledError&&delete b.unhandledError,b.animTimeout&&"anim"!=c)return clearTimeout(b.animTimeout),void delete b.animTimeout;if(b.continueDebug&&"normal"!=c)return void b.continueDebug();void 0===c&&(c="normal"),b.runMode=c,b.python.outputListeners=[],b.showHint("Running code..."),a("#btn_stopRunning").addClass("visibleButton");var d=b.files[b.currentFile];a("#run_filename").html("Running: "+b.currentFile),localStorage.lastRunCode=d,Sk.configure({breakpoints:function(a,c,d,e){if("anim"==b.runMode&&b.continueDebug&&(b.animTimeout=setTimeout(function(){b.runCode("anim")},1e3)),b.editor.gotoLine(c),b.unhandledError)throw b.unhandledError;return!0},debugging:!0,output:b.python.output,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread});var e="";e+='<div id="headerOut"></div>',e+='<pre id="consoleOut"><div id="watch"></div></pre>',e+="</pre>",d.indexOf("turtle")>0&&(e+='<div id="canvas"></div>'),a("#output").html(e),a("#dlg").show().modal(),a("#btn_stop").show(),b.whenFinished?a("#btn_hideConsole").hide():a("#btn_hideConsole").click(function(){a("#dlg").hide()});var f=[];"normal"!=c&&(f["Sk.debug"]=function(c){var d="<h2>Global variables:</h2><table><tr><th>Name</th><th>Data type</th><th>Value</th></tr>";b.watchVariables.expandHandlers=[];for(var e in c.child.$gbl){var f=c.child.$gbl[e],g=JSON.stringify(Sk.ffi.remapToJs(f));if(void 0===g&&(g=""),g&&g.length&&g.length>20){var h={id:b.watchVariables.expandHandlers.length,fullText:g,shortText:g.substring(0,17)};b.watchVariables.expandHandlers.push(h),g='<span class="debug_expand_zone" id="debug_expand_'+h.id+'">'+g.substring(0,17)+'<img src="/media/tools.png" class="debug_expand" title="Click to see full value"></span>'}var i=f.skType?f.skType:f.__proto__.tp$name;"function"!=i&&("str"==i&&(i="string"),void 0!==i&&(d+="<tr><td>"+e+"</td><td>"+i+"</td><td>"+g+"</td></tr>"))}d+="</table>",a("#watch").html(d),a("span.debug_expand_zone").click(function(c){var d=c.currentTarget.id,e=d.replace("debug_expand_","");a("#"+d).html(b.watchVariables.expandHandlers[e].fullText)});var j=new Promise(function(a,d){b.continueDebug=function(){return a(c.resume())},b.abortDebug=function(){return delete b.abortDebug,delete b.continueDebug,d("Program aborted")}});return j},setTimeout(function(){b.runCode(c)},100),a("#watch").show()),Sk.misceval.callsimAsync(f,function(){return Sk.importMainWithBody("try_it",!1,d,!0)}).then(function(c){b.showHint("Program finished running"),b.continueDebug&&delete b.continueDebug,b.abortDebug&&delete b.abortDebug,a("#btn_stop").hide(),a("#btn_stopRunning").removeClass("visibleButton").addClass("hiddenButton"),b.whenFinished&&b.whenFinished(),b.runTests()},b.handleError)},handleError:function(a){if(b.runTests(),!b.unhandledError&&b.continueDebug)return void(b.unhandledError=a);var c='<span class="error">'+a.toString()+"</span>";b.showHint(c),b.python.output(c)},load:function(){a.getJSON("api.php",{cmd:"load",id:b.instance},function(a){if(a.success&&a.data){var c=void 0;for(key in a.data){c=a.data[key];break}c&&c.files?(b.files=c.files,b.updateFileTabs(),b.editor.setValue(b.files[b.currentFile]),b.editor.clearSelection(),b.runTests(),b.showHint(a.message)):b.showHint("No files saved yet")}},function(a){console.log("Error",a)})},save:function(){var c={id:b.instance,files:b.files,score_try:0,score_debug:0,score_extend:0,score_total:0};for(file in b.tests){for(var d=0,e=0;e<b.tests[file].length;e++)b.tests[file][e].completed&&(d+=b.tests[file][e].points,c.score_total+=b.tests[file][e].points);switch(file){case"try_it.py":c.score_try+=d;break;case"debug_it.py":c.score_debug+=d;break;case"extend_it.py":c.score_extend+=d}}a.post("api.php?cmd=save",c,function(a){},"json")},autoSize:function(b){b&&"div"==b.target.localName||a(".holder").css({height:window.innerHeight-80})},tests:[],controlledTest:function(a,c){c.conditions||(c.conditions=[]);for(var d=c.conditions,e=0;e<d.length;e++)d[e].met=!1;var f=new Promise(function(e,f){function g(a){i<d.length&&d[i].o&&a.match(d[i].o)&&(d[i].met=!0,i++),a.trim().length>0}function h(a){var b="";return i<d.length&&d[i].p&&a.match(d[i].p)&&d[i].i&&(d[i].met=!0,b=d[i].i,i++),b}var i=0,j=JSON.parse(JSON.stringify(b.files)),k=Sk.inputfun;Sk.inputfun=h,Sk.configure({breakpoints:function(b,c,e,f){if(i<d.length&&d[i].c)for(var g=a.split("\n"),h=c-1;h>=0;h--){var j=g[h].split("#",2);if(j.length>1&&j[1].match(d[i].c)){d[i].met=!0,i++;break}if(h<c-1&&j[0].trim().length>0)break}if(i<d.length&&d[i].l){var g=a.split("\n");g.length>c&&g[c-1].match(d[i].l)&&(d[i].met=!0,i++)}return!0},debugging:!0,output:g,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread}),Sk.execLimit=2e3;var l=[];l["Sk.debug"]=function(a){i<d.length&&(d[i].g&&a.child.$gbl[d[i].g]&&Sk.ffi.remapToJs(a.child.$gbl[d[i].g])==d[i].v&&(d[i].met=!0,i++),d[i].f&&b.files[d[i].f]&&b.files[d[i].f].match(d[i].d)&&(d[i].met=!0,i++))},Sk.misceval.callsimAsync(l,function(){return Sk.importMainWithBody("test",!1,a,!0)}).then(function(a){Sk.inputfun=k,b.files=j,b.updateFileTabs();for(var f={conditions:d,met:0,total:0},g=0;g<d.length;g++)d[g].met&&f.met++,f.total++;f.met==f.total&&(c.completed=!0),e(f)},function(a){Sk.inputfun=k,b.updateFileTabs(),b.files=j,f(a)})});return f},runTests:function(){function a(){d<c.length?c[d].then(function(b){d++,a()},function(a){b.updateTests()}):(b.updateTests(),b.save())}var c=[];for(file in b.tests)for(var d=0;d<b.tests[file].length;d++){var e=b.tests[file][d];e.completed=!1;var f=b.files[file];e.codeHeader&&(f=e.codeHeader+"\n"+f),e.codeFooter&&(f+="\n"+e.codeFooter);var g=b.controlledTest(f,e);c.push(g)}var d=0;a()},updateTests:function(){var c={total:0},d={total:0};for(var e in b.tests){for(var f="<h3>Tests:</h3>",g=0;g<b.tests[e].length;g++){var h=b.tests[e][g];if(void 0==c[e]&&(c[e]=0),c[e]+=h.points,c.total+=h.points,f+='<div class="test_descriptions">',h.completed?(f+='<h4><i class="fa fa-check-circle-o test_passed"></i> ',void 0==d[e]&&(d[e]=0),d[e]+=h.points,d.total+=h.points):f+='<h4><i class="fa fa-times-circle-o test_failed"></i> ',void 0==h.description){h.description="<ol>";for(var i=0;i<h.conditions.length;i++){var j=h.conditions[i],k='<i class="fa fa-'+(j.met?"check test_passed":"times test_failed")+'"></i>';j.o&&(h.description+="<li>"+k+'Display the text: "'+j.o+'"</li>'),j.p&&(h.description+="<li>"+k+'Ask the user: "'+j.p+'"</li>'),j.g&&(h.description+="<li>"+k+"Set the variable "+j.g+" to the value "+j.v+"</li>"),j.f&&(h.description+="<li>"+k+"Save "+j.d+" into the file "+j.f+"</li>"),j.c&&(h.description+="<li>"+k+"Add a comment including "+j.c+"</li>"),j.l&&(h.description+="<li>"+k+'Include the text "'+j.l+'" in your code</li>')}h.description+="</ol>",f+=h.name+"</h4>"+h.description+"</div>",delete h.description}else f+=h.name+"</h4>"+h.description+"</div>"}var l="";switch(e){case"try_it.py":l="tests_try";break;case"debug_it.py":l="tests_debug";break;case"extend_it.py":l="tests_extend"}a("#"+l).html(f)}a("#points").html('<p>score:</p><span class="score">'+d.total+"</span><p>"+(c.total-d.total)+" more available</p>"),a(".try_total").html(" / "+c["try_it.py"]),a(".debug_total").html(" / "+c["debug_it.py"]),a(".extend_total").html(" / "+c["extend_it.py"]),a(".total_total").html(" / "+c.total),b.maxScores=c},inputLog:{},init:function(c){if(b.showHint(b.welcomeMessage),window.onresize=b.autoSize,b.updateFileTabs(),b.updateTests(),b.editor=ace.edit("editor"),b.editor.getSession().setMode("ace/mode/python"),b.editor.setTheme("ace/theme/dreamweaver"),b.editor.$blockScrolling=1/0,b.editor.setValue(b.files["try_it.py"]),b.editor.clearSelection(),b.editor.setShowPrintMargin(!1),b.load(),"embed"!=c&&"run"!=c&&b.editor.focus(),a("#btn_stop").click(function(){localStorage.loadAction="restoreCode",location.reload()}),b.editor.on("change",function(a){b.abortDebug&&b.abortDebug(),b.files[b.currentFile]=b.editor.getValue()}),a("#file_settings button").click(function(c){switch(c.currentTarget.id){case"btn_file_rename":var d=a("#txt_file_name").val();if(!d.match(/^[A-Za-z0-9_.]+$/)){b.showHint("Invalid file name");break}if(b.files[d]){b.showHint("A file with this name already exists");break}var e=b.files[b.currentFile];delete b.files[b.currentFile],b.currentFile=d,b.files[b.currentFile]=e,b.updateFileTabs(),a("#file_settings").hide().modal("hide"),b.editFile(d);break;case"btn_file_delete":delete b.files[b.currentFile],b.editFile("try_it.py");case"btn_file_cancel":a("#file_settings").hide().modal("hide")}}),localStorage&&!localStorage.options&&(localStorage.options={codeSize:12,outputSize:12,outputTransparency:0,stepAnimtime:1e3}),window.onerror=function(a){var c=a.toString().replace("Uncaught ",""),d='<span class="error">'+c+"</span>";return b.showHint(d),b.python.output(d),console.log(a),!0},a(window).keydown(function(a){if(a.ctrlKey)switch(a.keyCode){case 13:b.runCode("normal"),a.preventDefault();break;case 83:b.save(),a.preventDefault();break;case 190:a.altKey?b.abortDebug&&b.abortDebug():a.shiftKey?b.runCode("anim"):b.runCode("step"),a.preventDefault();break;case 66:b.load()}}),a("#btn_login").click(function(){a("#txt_username").val(),a("#txt_password").val()}),localStorage.loadAction){switch(localStorage.loadAction){case"showShare":b.showShare();break;case"restoreCode":b.editor.setValue(localStorage.lastRunCode)}delete localStorage.loadAction,b.editor.clearSelection(),b.editor.focus()}if((Sk.TurtleGraphics||(Sk.TurtleGraphics={})).target="canvas",Sk.inputfun=function(c){var d=new Promise(function(d,e){if(!(a("#raw_input_holder").length>0)){b.python.output('<form><div id="raw_input_holder"><label for="raw_input">'+c+'</label><input type="text" name="raw_input" id="raw_input" value=""/><button id="raw_input_accept" type="submit">OK</button></div></form>');a("#raw_input_accept").click(function(){var e=a("#raw_input").val();a("#raw_input_holder").remove(),b.python.output(c+' <span class="console_input">'+e+"</span>\n"),b.inputLog[c]||(b.inputLog[c]=[]),b.inputLog[c].push(e),d(e)});a("#raw_input").focus()}});return d},Sk.execLimit=1/0,Sk.configure({breakpoints:function(a,c,d,e){if("anim"==b.runMode&&b.continueDebug&&(b.animTimeout=setTimeout(function(){b.runCode("anim")},1e3)),b.editor.gotoLine(c),b.unhandledError)throw b.unhandledError;return!0},debugging:!0,output:b.python.output,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread}),Sk.externalLibraries={schooldirect:{path:"js/skulpt/schooldirect/__init__.js"},withcode:{path:"js/skulpt/withcode/__init__.js"},sqlite3:{path:"js/skulpt/sqlite3/__init__.js"},microbit:{path:"js/skulpt/microbit/__init__.js"},music:{path:"js/skulpt/music/__init__.js"},py3d:{path:"js/skulpt/py3d/__init__.js",dependencies:["js/skulpt/py3d/three.js"]}},a(".holder").css({height:window.innerHeight-80}),a("#footer").css({bottom:0}),a(".toolButton").hover(function(c){b.showHint(a("#"+c.currentTarget.id).attr("alt"))},function(a){b.showHint(b.welcomeMessage)}).click(function(c){switch(c.currentTarget.id){case"btn_edit":window.open(window.location.href.replace("embed","python").replace("run","python"));break;case"btn_show_recover":b.recover();break;case"btn_stopRunning":localStorage.loadAction="restoreCode",location.reload();break;case"btn_tools":b.toolsVisible=!b.toolsVisible,b.toolsVisible?a(".toolButton").addClass("visibleButton"):a(".toolButton").removeClass("visibleButton");break;case"btn_show_output":a("#dlg").show().modal();break;case"btn_run":b.runCode(b.runMode)}}),"run"==c){a("#editor").hide();var d=a("#output").detach();a("#holder").append(d),a("#dlg").remove(),b.whenFinished=function(){var c=window.location.href.replace("run/","python/"),d='<div><a class="nounderline" href="http://withcode.uk" target="_blank"><h1 id="title" onmouseover="animateTitle(\'create.withcode.uk\', \'title_text\')"><span class="brackets">{</span><span id="title_text">withcode.uk</span><span class="brackets">}</span></h1></a></div>';b.python.output(d+'<p>This python app was written using <a href="https://create.withcode.uk">create.withcode.uk</a>. <a href="'+c+'">Click here to edit the python code and create/share your own version</a> or check out <a href="http://blog.withcode.uk">blog.withcode.uk</a> for ideas, tips and resources</p> <button id="btn_run_again">Run again</button>'),a("#btn_run_again").click(function(){b.runCode()})},b.runCode()}}};return b});