define(["jquery"],function(a){var b={toolsVisible:!1,editFile:function(a){b.files[b.currentFile]&&(b.files[b.currentFile]=b.editor.getValue()),b.currentFile=a,b.editor.setValue(b.files[a]),b.editor.clearSelection(),b.editor.focus();var c=a.match(/(\.[^.]+)/);switch(c&&c.length>1&&(c=c[1]),c){case".py":b.editor.getSession().setMode("ace/mode/python");break;case".html":b.editor.getSession().setMode("ace/mode/html");break;case".js":b.editor.getSession().setMode("ace/mode/javascript");break;case".sql":b.editor.getSession().setMode("ace/mode/mysql");break;default:b.editor.getSession().setMode("ace/mode/text")}b.updateFileTabs()},updateFileTabs:function(){var c="";for(var d in b.files)c+='<span class="file_tab',d==b.currentFile?(c+=' file_tab_selected">',"try_it.py"!=d&&"debug_it.py"!=d&&"extend_it.py"!=d&&(c+='<img class="btn_file_settings" alt="File settings" title="File settings" src="pix/settings.png">')):c+='">',c+=d+"</span>";c+='<span class="file_tab"><img class="btn_file_settings" alt="Create new file" title="Create new file" src="pix/tools.png"></span>',a("#file_tabs").html(c),a(".file_tab").click(function(c){var d=c.currentTarget.textContent;switch(d){case"":d="newfile.txt",void 0===b.files[d]&&(b.files[d]=""),b.editFile("newfile.txt");break;case b.currentFile:"try_it.py"!=d&&"debug_it.py"!=d&&"extend_it.py"!=d&&(a("#file_settings").show().modal(),a("#txt_file_name").val(d).focus());break;default:b.editFile(c.currentTarget.textContent)}})},currentFile:"try_it.py",countFiles:function(){var a=0;for(var c in b.files)a++;return a},files:{"try_it.py":""},readFile:function(a){return b.files[a]},writeFile:function(a,c){b.files[a]=c,b.updateFileTabs()},welcomeMessage:"Press Ctrl+Enter to run",getOption:function(a,b){return localStorage&&localStorage["OPT_"+a]?localStorage["OPT_"+a]:b},setOption:function(a,b){return localStorage["OPT_"+a]=b,b},showHint:function(c){b.hideHintTimeout&&clearTimeout(b.hideHintTimeout),b.hideHintTimeout=setTimeout(function(){delete b.hideHintTimeout,a("#hintBar").fadeOut()},5e3),a("#hintBar").html(c).show()},python:{outputListeners:[],output:function(a,c){var d=void 0==c?"consoleOut":"headerOut",e=document.getElementById(d);e.innerHTML+=a;for(var f=0;f<b.python.outputListeners.length;){var g=b.python.outputListeners[f];try{g(a),f++}catch(h){b.python.outputListeners.splice(f,1)}}var e=e.parentNode.parentNode;e.scrollTop=e.scrollHeight},clear:function(){var a=document.getElementById("consoleOut");a.innerHTML="";var a=a.parentNode.parentNode;a.scrollTop=a.scrollHeight},builtinread:function(a){if(void 0===Sk.builtinFiles||void 0===Sk.builtinFiles.files[a])throw"File not found: '"+a+"'";return Sk.builtinFiles.files[a]}},runAsync:function(a){var c,d=new Promise(a),e=new Sk.misceval.Suspension;return e.resume=function(){return c},e.data={type:"Sk.promise",promise:d.then(function(a){return c=a,a},function(a){return c="",b.handleError(a),new Promise(function(a,b){})})},e},watchVariables:{expandHandlers:[]},runCode:function(c){if(b.unhandledError&&delete b.unhandledError,b.animTimeout&&"anim"!=c)return clearTimeout(b.animTimeout),void delete b.animTimeout;if(b.continueDebug&&"normal"!=c)return void b.continueDebug();void 0===c&&(c="normal"),b.runMode=c,b.python.outputListeners=[],b.showHint("Running code..."),a("#btn_stopRunning").addClass("visibleButton");var d=b.files[b.currentFile];a("#run_filename").html("Running: "+b.currentFile),localStorage.lastRunCode=d,Sk.configure({breakpoints:function(a,c,d,e){if("anim"==b.runMode&&b.continueDebug&&(b.animTimeout=setTimeout(function(){b.runCode("anim")},1e3)),b.editor.gotoLine(c),b.unhandledError)throw b.unhandledError;return!0},debugging:!0,output:b.python.output,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread});var e="";e+='<div id="headerOut"></div>',e+='<pre id="consoleOut"><div id="watch"></div></pre>',e+="</pre>",d.indexOf("turtle")>0&&(e+='<div id="canvas"></div>'),a("#output").html(e),a("#dlg").show().modal(),a("#btn_stop").show(),b.whenFinished?a("#btn_hideConsole").hide():a("#btn_hideConsole").click(function(){a("#dlg").hide()});var f=[];"normal"!=c&&(f["Sk.debug"]=function(c){var d="<h2>Global variables:</h2><table><tr><th>Name</th><th>Data type</th><th>Value</th></tr>";b.watchVariables.expandHandlers=[];for(var e in c.child.$gbl){var f=c.child.$gbl[e],g=JSON.stringify(Sk.ffi.remapToJs(f));if(void 0===g&&(g=""),g&&g.length&&g.length>20){var h={id:b.watchVariables.expandHandlers.length,fullText:g,shortText:g.substring(0,17)};b.watchVariables.expandHandlers.push(h),g='<span class="debug_expand_zone" id="debug_expand_'+h.id+'">'+g.substring(0,17)+'<img src="/media/tools.png" class="debug_expand" title="Click to see full value"></span>'}var i=f.skType?f.skType:f.__proto__.tp$name;"function"!=i&&("str"==i&&(i="string"),void 0!==i&&(d+="<tr><td>"+e+"</td><td>"+i+"</td><td>"+g+"</td></tr>"))}d+="</table>",a("#watch").html(d),a("span.debug_expand_zone").click(function(c){var d=c.currentTarget.id,e=d.replace("debug_expand_","");a("#"+d).html(b.watchVariables.expandHandlers[e].fullText)});var j=new Promise(function(a,d){b.continueDebug=function(){return a(c.resume())},b.abortDebug=function(){return delete b.abortDebug,delete b.continueDebug,d("Program aborted")}});return j},setTimeout(function(){b.runCode(c)},100),a("#watch").show()),Sk.misceval.callsimAsync(f,function(){return Sk.importMainWithBody("try_it",!1,d,!0)}).then(function(c){b.showHint("Program finished running"),b.continueDebug&&delete b.continueDebug,b.abortDebug&&delete b.abortDebug,a("#btn_stop").hide(),a("#btn_stopRunning").removeClass("visibleButton").addClass("hiddenButton"),b.whenFinished&&b.whenFinished(),b.runTests()},b.handleError)},handleError:function(a){if(b.runTests(),!b.unhandledError&&b.continueDebug)return void(b.unhandledError=a);var c='<span class="error">'+a.toString()+"</span>";b.showHint(c),b.python.output(c)},load:function(){a.getJSON("api.php",{cmd:"load",id:b.instance},function(a){if(a.success&&a.data){var c=void 0;for(key in a.data){c=a.data[key];break}c&&c.files?(b.files=c.files,b.updateFileTabs(),b.editor.setValue(b.files[b.currentFile]),b.editor.clearSelection(),b.runTests(),b.showHint(a.message)):b.showHint("No files saved yet")}},function(a){console.log("Error",a)})},save:function(){var c={id:b.instance,files:b.files,score_try:0,score_debug:0,score_extend:0,score_total:0};for(file in b.tests){for(var d=0,e=0;e<b.tests[file].length;e++)b.tests[file][e].completed>0&&(d+=b.tests[file][e].points*b.tests[file][e].completed,c.score_total+=b.tests[file][e].points*b.tests[file][e].completed);switch(d=Math.round(d),c.score_total=Math.round(c.score_total),file){case"try_it.py":c.score_try+=d;break;case"debug_it.py":c.score_debug+=d;break;case"extend_it.py":c.score_extend+=d}}a.post("api.php?cmd=save",c,function(a){},"json")},autoSize:function(b){b&&"div"==b.target.localName||a(".holder").css({height:window.innerHeight-80})},tests:[],controlledTest:function(a,c,d){c.conditions||(c.conditions=[]),void 0===d&&(d=0);for(var e=c.conditions,f=0;f<e.length;f++)e[f].met[d]=!1;var g=new Promise(function(f,g){function h(a){k<e.length&&e[k].o&&(Array.isArray(e[k].o)?a.match(e[k].o[d])&&(e[k].met[d]=!0,k++):a.match(e[k].o)&&(e[k].met[d]=!0,k++)),a.trim().length>0}function i(a){var b="";return k<e.length&&e[k].i&&(Array.isArray(e[k].i)?e[k].p?a.match(e[k].p)&&(e[k].met[d]=!0,b=e[k].i[d],k++):(e[k].met[d]=!0,b=e[k].i[d],k++):e[k].p?a.match(e[k].p)&&(e[k].met[d]=!0,b=e[k].i,k++):(e[k].met[d]=!0,b=e[k].i[d],k++)),b}function j(a){if(k<e.length&&e[k]&&a[e[k].g]){var c=e[k].g,f=Array.isArray(e[k].v)?e[k].v[d]:e[k].v;Sk.ffi.remapToJs(a[c])==f&&(e[k].met[d]=!0,k++)}k<e.length&&e[k].f&&b.files[e[k].f]&&b.files[e[k].f].match(e[k].d)&&(e[k].met[d]=!0,k++)}var k=0,l=JSON.parse(JSON.stringify(b.files)),m=Sk.inputfun;Sk.inputfun=i,Sk.configure({breakpoints:function(b,c,f,g){if(k<e.length&&e[k].c)for(var h=a.split("\n"),i=c-1;i>=0;i--){var j=h[i].split("#",2);if(j.length>1&&j[1].match(e[k].c)){e[k].met[d]=!0,k++;break}if(i<c-1&&j[0].trim().length>0)break}if(k<e.length&&e[k].l){var h=a.split("\n");h.length>c&&h[c-1].match(e[k].l)&&(e[k].met[d]=!0,k++)}return!0},debugging:!0,output:h,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread}),Sk.execLimit=2e3,Sk.python3=!0;var n=[];n["Sk.debug"]=function(a){j(a.child.$gbl)},Sk.misceval.callsimAsync(n,function(){return Sk.importMainWithBody("test",!1,a,!0)}).then(function(a){j(a.$d),Sk.inputfun=m,b.files=l,b.updateFileTabs();for(var d={conditions:e,met:0,total:0},g=0;g<e.length;g++){var h=0;if(Array.isArray(e[g].met)){for(var i=0;i<e[g].met.length;i++)e[g].met[i]&&h++;d.met+=h/e[g].met.length}else h=e[g].met?1:0,d.met+=h;d.total++}d.total<1?c.completed=0:c.completed=d.met/d.total,f(d)},function(a){Sk.inputfun=m,b.updateFileTabs(),b.files=l,g(a)})});return g},runTests:function(){function a(){d<c.length?c[d].then(function(b){d++,a()},function(a){b.updateTests()}):(b.updateTests(),b.save())}var c=[];for(file in b.tests)for(var d=0;d<b.tests[file].length;d++){var e=b.tests[file][d];e.completed=0;var f=b.files[file];e.codeHeader&&(f=e.codeHeader+"\n"+f),e.codeFooter&&(f+="\n"+e.codeFooter),e.iterations||(e.iterations=1);for(var g=0;g<e.conditions.length;g++){e.conditions[g].met=[];for(var h=0;h<e.iterations;h++)e.conditions[g].met[h]=!1}for(var g=0;g<e.iterations;g++){var i=b.controlledTest(f,e,g);c.push(i)}}var d=0;a()},updateTests:function(){function c(a,b){return a+1+"."+(b+1)}function d(a,b){return Array.isArray(a)?a[b]:a}function e(a,b){var c=!1;return a.met&&(c=!Array.isArray(a.met)||a.met[b]),c?'<i class="fa fa-check-circle-o test_passed"></i>':'<i class="fa fa-times-circle-o test_failed"></i>'}var f={total:0},g={total:0};for(var h in b.tests){for(var i="<h3>Tests:</h3>",j=0;j<b.tests[h].length;j++){var k=b.tests[h][j],l="";l=1==k.completed?'<i class="fa fa-check-circle-o test_passed"></i>':k.completed>0?'<i class="fa fa-check-circle-o test_partial"></i>':'<i class="fa fa-times-circle-o test_failed"></i>';var m=[],n=["Test number"];m.push(n);for(var o=0;o<k.iterations;o++){var n=[c(j,o)];m.push(n)}for(var o=0;o<k.conditions.length;o++){var p=k.conditions[o];if(p.i){m[0].push(p.p?"Test data when asked: <pre>"+p.p+"</pre>":"Test data:");for(var q=0;q<k.iterations;q++){var r=e(p,q);m[1+q].push(r+" <pre>"+d(p.i,q)+"</pre>")}}if(p.o){m[0].push("Expected output");for(var q=0;q<k.iterations;q++){var r=e(p,q);m[1+q].push(r+" <pre>"+d(p.o,q)+"</pre>")}}if(p.g){m[0].push("Expected value of <pre>"+p.g+"</pre> variable");for(var q=0;q<k.iterations;q++){var r=e(p,q);m[1+q].push(r+" <pre>"+d(p.v,q)+"</pre>")}}}var s=(k.completed?Math.round(100*k.completed):"0")+"%",t=h.replace(".py","_");i+='<button class="btn btn-secondary" data-toggle="collapse" data-target="#test-'+t+"-"+j+'">'+l+" "+k.name+" ("+s+")</button>",i+='<div id="test-'+t+"-"+j+'" class="collapse"><table class="table">';for(var u=0;u<m.length;u++){var v="td";0==u&&(i+="<thead>",v="th"),i+="<tr>";for(var w=0;w<m[u].length;w++)i+="<"+v+">"+m[u][w]+"</"+v+">";i+="</tr>",0==u&&(i+="</thead>")}i+="</table></div>",void 0==f[h]&&(f[h]=0),f[h]+=k.points,f.total+=k.points,k.completed>0&&(void 0==g[h]&&(g[h]=0),g[h]+=k.points*k.completed,g.total+=k.points*k.completed)}var x="";switch(h){case"try_it.py":x="tests_try";break;case"debug_it.py":x="tests_debug";break;case"extend_it.py":x="tests_extend"}a("#"+x).html(i)}a("#points").html('<p>score:</p><span class="score">'+Math.round(g.total)+"</span><p>"+Math.round(f.total-g.total)+" more available</p>"),a(".try_total").html(" / "+f["try_it.py"]),a(".debug_total").html(" / "+f["debug_it.py"]),a(".extend_total").html(" / "+f["extend_it.py"]),a(".total_total").html(" / "+f.total),b.maxScores=f},inputLog:{},init:function(c){if(b.showHint(b.welcomeMessage),window.onresize=b.autoSize,b.updateFileTabs(),b.updateTests(),b.editor=ace.edit("editor"),b.editor.getSession().setMode("ace/mode/python"),b.editor.setTheme("ace/theme/dreamweaver"),b.editor.$blockScrolling=1/0,b.editor.setValue(b.files["try_it.py"]),b.editor.clearSelection(),b.editor.setShowPrintMargin(!1),b.load(),"embed"!=c&&"run"!=c&&b.editor.focus(),a("#btn_stop").click(function(){localStorage.loadAction="restoreCode",location.reload()}),b.editor.on("change",function(a){b.abortDebug&&b.abortDebug(),b.files[b.currentFile]=b.editor.getValue()}),a("#file_settings button").click(function(c){switch(c.currentTarget.id){case"btn_file_rename":var d=a("#txt_file_name").val();if(!d.match(/^[A-Za-z0-9_.]+$/)){b.showHint("Invalid file name");break}if(b.files[d]){b.showHint("A file with this name already exists");break}var e=b.files[b.currentFile];delete b.files[b.currentFile],b.currentFile=d,b.files[b.currentFile]=e,b.updateFileTabs(),a("#file_settings").hide().modal("hide"),b.editFile(d);break;case"btn_file_delete":delete b.files[b.currentFile],b.editFile("try_it.py");case"btn_file_cancel":a("#file_settings").hide().modal("hide")}}),localStorage&&!localStorage.options&&(localStorage.options={codeSize:12,outputSize:12,outputTransparency:0,stepAnimtime:1e3}),window.onerror=function(a){var c=a.toString().replace("Uncaught ",""),d='<span class="error">'+c+"</span>";return b.showHint(d),b.python.output(d),console.log(a),!0},a(window).keydown(function(a){if(a.ctrlKey)switch(a.keyCode){case 13:b.runCode("normal"),a.preventDefault();break;case 83:b.save(),a.preventDefault();break;case 190:a.altKey?b.abortDebug&&b.abortDebug():a.shiftKey?b.runCode("anim"):b.runCode("step"),a.preventDefault();break;case 66:b.load()}}),a("#btn_login").click(function(){a("#txt_username").val(),a("#txt_password").val()}),localStorage.loadAction){switch(localStorage.loadAction){case"showShare":b.showShare();break;case"restoreCode":b.editor.setValue(localStorage.lastRunCode)}delete localStorage.loadAction,b.editor.clearSelection(),b.editor.focus()}if((Sk.TurtleGraphics||(Sk.TurtleGraphics={})).target="canvas",Sk.inputfun=function(c){var d=new Promise(function(d,e){if(!(a("#raw_input_holder").length>0)){b.python.output('<form><div id="raw_input_holder"><label for="raw_input">'+c+'</label><input type="text" name="raw_input" id="raw_input" value=""/><button id="raw_input_accept" type="submit">OK</button></div></form>');a("#raw_input_accept").click(function(){var e=a("#raw_input").val();a("#raw_input_holder").remove(),b.python.output(c+' <span class="console_input">'+e+"</span>\n"),b.inputLog[c]||(b.inputLog[c]=[]),b.inputLog[c].push(e),d(e)});a("#raw_input").focus()}});return d},Sk.execLimit=1/0,Sk.configure({breakpoints:function(a,c,d,e){if("anim"==b.runMode&&b.continueDebug&&(b.animTimeout=setTimeout(function(){b.runCode("anim")},1e3)),b.editor.gotoLine(c),b.unhandledError)throw b.unhandledError;return!0},debugging:!0,output:b.python.output,readFile:b.readFile,writeFile:b.writeFile,read:b.python.builtinread}),Sk.externalLibraries={schooldirect:{path:"js/skulpt/schooldirect/__init__.js"},withcode:{path:"js/skulpt/withcode/__init__.js"},sqlite3:{path:"js/skulpt/sqlite3/__init__.js"},microbit:{path:"js/skulpt/microbit/__init__.js"},music:{path:"js/skulpt/music/__init__.js"},py3d:{path:"js/skulpt/py3d/__init__.js",dependencies:["js/skulpt/py3d/three.js"]}},a(".holder").css({height:window.innerHeight-80}),a("#footer").css({bottom:0}),a(".toolButton").hover(function(c){b.showHint(a("#"+c.currentTarget.id).attr("alt"))},function(a){b.showHint(b.welcomeMessage)}).click(function(c){switch(c.currentTarget.id){case"btn_edit":window.open(window.location.href.replace("embed","python").replace("run","python"));break;case"btn_show_recover":b.recover();break;case"btn_stopRunning":localStorage.loadAction="restoreCode",location.reload();break;case"btn_tools":b.toolsVisible=!b.toolsVisible,b.toolsVisible?a(".toolButton").addClass("visibleButton"):a(".toolButton").removeClass("visibleButton");break;case"btn_show_output":a("#dlg").show().modal();break;case"btn_run":b.runCode(b.runMode)}}),"run"==c){a("#editor").hide();var d=a("#output").detach();a("#holder").append(d),a("#dlg").remove(),b.whenFinished=function(){var c=window.location.href.replace("run/","python/"),d='<div><a class="nounderline" href="http://withcode.uk" target="_blank"><h1 id="title" onmouseover="animateTitle(\'create.withcode.uk\', \'title_text\')"><span class="brackets">{</span><span id="title_text">withcode.uk</span><span class="brackets">}</span></h1></a></div>';b.python.output(d+'<p>This python app was written using <a href="https://create.withcode.uk">create.withcode.uk</a>. <a href="'+c+'">Click here to edit the python code and create/share your own version</a> or check out <a href="http://blog.withcode.uk">blog.withcode.uk</a> for ideas, tips and resources</p> <button id="btn_run_again">Run again</button>'),a("#btn_run_again").click(function(){b.runCode()})},b.runCode()}}};return b});